#!/bin/bash

set -eux

my_dir="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"

# This script expects that it lives one directory below the base directory.
base_dir="$( cd "${my_dir}/.." && pwd )"

export CF_RELEASE_DIR="${CF_RELEASE_DIR:-${base_dir}/tmp/cf-release}"

mkdir -p "${CF_RELEASE_DIR}"

pushd "${CF_RELEASE_DIR}" > /dev/null
git remote -v | grep 'cf-release' || \
  (git clone https://github.com/cloudfoundry/cf-release . \
  && git checkout develop \
  && ./scripts/update)
popd > /dev/null

fixtures_dir="$( cd "${base_dir}/fixtures" && pwd )"
stemcell_path="${fixtures_dir}/no-image-stemcell.tgz"

# Replace $CF_RELEASE_DIR in template with actual value
sed \
  "s@\$CF_RELEASE_DIR@${CF_RELEASE_DIR}@" \
  "${fixtures_dir}/manifest.yml.template" > "${fixtures_dir}/manifest.yml.tmp"

# Replace $CF_RELEASE_DIR in template with actual value
sed \
  "s@\$STEMCELL_PATH@${stemcell_path}@" \
  "${fixtures_dir}/manifest.yml.tmp" > "${fixtures_dir}/manifest.yml"

pushd "${base_dir}" > /dev/null
  ginkgo \
    -p \
    -r \
    -race \
    -randomizeAllSpecs \
    -randomizeSuites \
    -failOnPending \
    -skipPackage tmp \
    "$@" | grep -v './tmp' | grep -v 'Will skip:'
popd > /dev/null
